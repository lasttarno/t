name: Test2
on: workflow_dispatch

jobs:
  setup:
    runs-on: windows-latest
    steps:
    - name: Enable Requirements
      run: |
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -name "fDenyTSConnections" -Value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        
        reg add "HKLM\SOFTWARE\Policies\Microsoft\Windows NT\Terminal Services" /v SelectTransport /t REG_DWORD /d 1 /f
        
        New-NetFirewallRule -DisplayName "RDP-UDP" -Direction Inbound -Protocol UDP -LocalPort 3389 -Action Allow
        New-NetFirewallRule -DisplayName "RDP-TCP" -Direction Inbound -Protocol TCP -LocalPort 3389 -Action Allow
        
        $securePassword = ConvertTo-SecureString "${{ secrets.RPW }}" -AsPlainText -Force
        Set-LocalUser -Name "runneradmin" -Password $securePassword

    - name: Install
      run: |
        Invoke-WebRequest -Uri "https://github.com/playit-cloud/playit-agent/releases/download/v0.15.26/playit-windows-x86_64-signed.exe" -OutFile "playit.exe"

    - name: Start Service
      env:
        PIT_AUTH_KEY: ${{ secrets.PL }}
      run: |

        $config = @"
        tunnels:
          - name: rdp-udp
            protocol: udp
            bind_address: 127.0.0.1
            bind_port: 3389
        "@
        
        $config | Out-File -FilePath "playit-config.yml" -Encoding UTF8
        

        Start-Process -FilePath ".\playit.exe" -ArgumentList "--secret $env:PIT_AUTH_KEY --config playit-config.yml" -NoNewWindow

    - name: Keep alive
      run: |
        Start-Sleep -Seconds 3540
